<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VNRT - Crear Slice</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/dashboard.css') }}" rel="stylesheet">
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        #custom-topology-container {
            height: 400px;
            border: 1px solid #ddd;
            margin: 20px 0;
            border-radius: 8px;
        }
        .vm-config-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .topology-selection {
            display: flex;
            gap: 15px;
            margin: 20px 0;
        }
        .topology-option {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .topology-option:hover {
            border-color: #28a745;
        }
        .topology-option.selected {
            border-color: #28a745;
            background-color: #f8f9fa;
        }
        .node-counter {
            background-color: #e9ecef;
            border-radius: 5px;
            padding: 8px 12px;
            margin-bottom: 15px;
            font-size: 0.9em;
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="dashboard-body">
    <div class="container-fluid p-0">
        <!-- Navigation -->
        <nav class="navbar navbar-expand-lg">
            <div class="container-fluid">
                <div class="navbar-brand">
                    <i class="fas fa-cloud me-2"></i>
                    <strong>VNRT</strong>
                    <span class="ms-2 text-muted">| Crear Slice</span>
                </div>
                <div class="navbar-nav ms-auto">
                    <div class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle user-menu" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle me-1"></i>{{ session.username }}
                        </a>
                        <div class="dropdown-menu dropdown-menu-end">
                            <a class="dropdown-item" href="{{ url_for('dashboard') }}">
                                <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                            </a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="{{ url_for('logout') }}">
                                <i class="fas fa-sign-out-alt me-1"></i>Logout
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="main-content">
            <div class="page-header">
                <h1 class="page-title">Crear Nuevo Slice</h1>
                <p class="page-subtitle">Configure las instancias virtuales y su topología de red</p>
            </div>

            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <form method="POST" id="create-slice-form">
                <!-- Step 0: Slice Name -->
                <div class="content-card mb-4">
                    <h4><i class="fas fa-tag me-2"></i>Información del Slice</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <label for="slice_name" class="form-label">Nombre del Slice</label>
                            <input type="text" class="form-control" id="slice_name" name="slice_name" required placeholder="Ej: TEL141_2025-2_20206466">
                        </div>
                    </div>
                </div>
                
                <!-- Step 1: Number of VMs -->
                <div class="content-card mb-4">
                    <h4><i class="fas fa-server me-2"></i>Configuración de Instancias</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <label for="num_vms" class="form-label">Número de VMs</label>
                            <input type="number" class="form-control" id="num_vms" name="num_vms" min="1" max="10" value="2" required onchange="handleVMCountChange()">
                        </div>
                    </div>
                </div>

                <!-- Step 2: VM Configuration -->
                <div class="content-card mb-4" id="vm-config-section">
                    <h4><i class="fas fa-cogs me-2"></i>Configuración de VMs</h4>
                    <div id="vm-configs">
                        <!-- VM configurations will be generated here -->
                    </div>
                </div>

                <!-- Step 3: Topology Selection -->
                <div class="content-card mb-4">
                    <h4><i class="fas fa-project-diagram me-2"></i>Selección de Topología</h4>
                    <div class="topology-selection">
                        <div class="topology-option" data-topology="star" onclick="selectTopology('star')">
                            <i class="fas fa-star fa-2x mb-2"></i>
                            <h6>Estrella</h6>
                            <small>Todas las VMs conectadas a un nodo central</small>
                        </div>
                        <div class="topology-option" data-topology="tree" onclick="selectTopology('tree')">
                            <i class="fas fa-sitemap fa-2x mb-2"></i>
                            <h6>Árbol</h6>
                            <small>Estructura jerárquica de conexiones</small>
                        </div>
                        <div class="topology-option" data-topology="custom" onclick="selectTopology('custom')">
                            <i class="fas fa-paint-brush fa-2x mb-2"></i>
                            <h6>Personalizada</h6>
                            <small>Diseña tu propia topología</small>
                        </div>
                    </div>
                    <input type="hidden" id="topology_type" name="topology_type" value="star" required>
                </div>

                <!-- Step 4: Custom Topology Designer -->
                <div class="content-card mb-4" id="custom-topology-card" style="display: none;">
                    <h4><i class="fas fa-pencil-ruler me-2"></i>Diseñador de Topología</h4>
                    <p class="text-muted">Usa los controles para crear nodos y conectarlos. La topología se guardará automáticamente.</p>
                    
                    <div class="node-counter">
                        <i class="fas fa-info-circle me-2"></i>
                        <span id="node-count-display">Nodos: 0 / 2</span>
                        <span class="text-muted ms-2">(Máximo basado en el número de VMs configuradas)</span>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <button type="button" class="btn btn-success btn-sm" id="add-node-btn" onclick="addCustomNode()">
                                <i class="fas fa-plus me-1"></i>Agregar Nodo
                            </button>
                        </div>
                        <div class="col-md-4">
                            <select id="fromNode" class="form-select form-select-sm">
                                <option value="">Nodo origen</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <select id="toNode" class="form-select form-select-sm">
                                <option value="">Nodo destino</option>
                            </select>
                        </div>
                        <div class="col-md-1">
                            <button type="button" class="btn btn-primary btn-sm" onclick="addCustomEdge()">
                                <i class="fas fa-link"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div id="custom-topology-container"></div>
                    <input type="hidden" id="topology_data" name="topology_data">
                </div>

                <!-- Submit Button -->
                <div class="content-card">
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-1"></i>Cancelar
                        </a>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save me-1"></i>Crear Slice
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        let customNetwork = null;
        let customNodes = null;
        let customEdges = null;
        let customNodeId = 1;

        function generateVMConfig() {
            const numVMs = document.getElementById('num_vms').value;
            const container = document.getElementById('vm-configs');
            container.innerHTML = '';

            for (let i = 1; i <= numVMs; i++) {
                const vmCard = document.createElement('div');
                vmCard.className = 'vm-config-card';
                vmCard.innerHTML = `
                    <h6><i class="fas fa-desktop me-2"></i>VM ${i}</h6>
                    <div class="row">
                        <div class="col-md-3">
                            <label class="form-label">Nombre</label>
                            <input type="text" class="form-control" name="vm_${i}_name" value="VM${i}" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">CPU</label>
                            <input type="text" class="form-control" name="vm_${i}_cpu" value="1" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">RAM</label>
                            <input type="text" class="form-control" name="vm_${i}_ram" value="1GB" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Almacenamiento</label>
                            <input type="text" class="form-control" name="vm_${i}_storage" value="10GB" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Imagen</label>
                            <select class="form-select" name="vm_${i}_image" required>
                                <option value="ubuntu:latest">Ubuntu Latest</option>
                                <option value="centos:latest">CentOS Latest</option>
                                <option value="debian:latest">Debian Latest</option>
                                <option value="alpine:latest">Alpine Latest</option>
                            </select>
                        </div>
                    </div>
                `;
                container.appendChild(vmCard);
            }
        }

        function handleVMCountChange() {
            generateVMConfig();
            updateNodeCountDisplay();
            
            // Si hay una topología personalizada activa, validar los nodos existentes
            if (customNodes && document.getElementById('topology_type').value === 'custom') {
                validateExistingNodes();
            }
        }

        function validateExistingNodes() {
            const maxVMs = parseInt(document.getElementById('num_vms').value);
            const currentNodes = customNodes.get();
            
            // Si hay más nodos que VMs permitidas, eliminar los excedentes
            if (currentNodes.length > maxVMs) {
                const nodesToRemove = currentNodes.slice(maxVMs);
                const nodeIdsToRemove = nodesToRemove.map(node => node.id);
                
                // Eliminar nodos excedentes
                customNodes.remove(nodeIdsToRemove);
                
                // Eliminar conexiones que involucren los nodos eliminados
                const existingEdges = customEdges.get();
                const edgesToRemove = existingEdges.filter(edge => 
                    nodeIdsToRemove.includes(edge.from) || nodeIdsToRemove.includes(edge.to)
                );
                customEdges.remove(edgesToRemove.map(edge => edge.id));
                
                updateSelectOptions();
                updateTopologyData();
                
                // Mostrar mensaje informativo
                alert(`Se eliminaron ${nodesToRemove.length} nodo(s) porque excedían el límite de ${maxVMs} VMs configuradas.`);
            }
        }

        function selectTopology(type) {
            // Remove selected class from all options
            document.querySelectorAll('.topology-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Add selected class to clicked option
            document.querySelector(`[data-topology="${type}"]`).classList.add('selected');
            document.getElementById('topology_type').value = type;
            
            // Show/hide custom topology designer
            const customCard = document.getElementById('custom-topology-card');
            if (type === 'custom') {
                customCard.style.display = 'block';
                initCustomTopology();
                updateNodeCountDisplay();
            } else {
                customCard.style.display = 'none';
            }
        }

        function initCustomTopology() {
            const container = document.getElementById('custom-topology-container');
            
            // Initialize nodes and edges
            customNodes = new vis.DataSet([]);
            customEdges = new vis.DataSet([]);
            customNodeId = 1;
            
            const data = { nodes: customNodes, edges: customEdges };
            const options = {
                nodes: {
                    shape: 'circle',
                    size: 25,
                    font: { size: 14, color: '#333333' },
                    borderWidth: 2,
                    color: { background: '#28a745', border: '#1e7e34' }
                },
                edges: {
                    width: 2,
                    color: '#848484',
                    smooth: { type: 'continuous' }
                },
                physics: {
                    enabled: true,
                    stabilization: { enabled: true, iterations: 100 }
                }
            };
            
            customNetwork = new vis.Network(container, data, options);
            
            // Update topology data when network changes
            customNetwork.on('afterDrawing', updateTopologyData);
            
            updateSelectOptions();
            updateNodeCountDisplay();
        }

        function addCustomNode() {
            const maxVMs = parseInt(document.getElementById('num_vms').value);
            const currentNodeCount = customNodes ? customNodes.length : 0;
            
            if (currentNodeCount >= maxVMs) {
                alert(`No se pueden agregar más nodos. El límite es ${maxVMs} nodos basado en el número de VMs configuradas.`);
                return;
            }
            
            const newNode = {
                id: customNodeId,
                label: `VM${customNodeId}`,
                color: { background: '#28a745', border: '#1e7e34' }
            };
            customNodes.add(newNode);
            customNodeId++;
            updateSelectOptions();
            updateTopologyData();
            updateNodeCountDisplay();
        }

        function addCustomEdge() {
            const fromNode = document.getElementById('fromNode').value;
            const toNode = document.getElementById('toNode').value;
            
            if (fromNode && toNode && fromNode !== toNode) {
                // Verificar si ya existe una conexión entre estos nodos
                const existingEdges = customEdges.get();
                const edgeExists = existingEdges.some(edge => 
                    (edge.from == fromNode && edge.to == toNode) || 
                    (edge.from == toNode && edge.to == fromNode)
                );
                
                if (edgeExists) {
                    alert('Ya existe una conexión entre estos nodos.');
                    return;
                }
                
                const newEdge = {
                    from: parseInt(fromNode),
                    to: parseInt(toNode)
                };
                customEdges.add(newEdge);
                updateTopologyData();
            } else {
                alert('Por favor selecciona dos nodos diferentes para conectar.');
            }
        }

        function updateSelectOptions() {
            const fromSelect = document.getElementById('fromNode');
            const toSelect = document.getElementById('toNode');
            
            fromSelect.innerHTML = '<option value="">Nodo origen</option>';
            toSelect.innerHTML = '<option value="">Nodo destino</option>';
            
            if (customNodes) {
                customNodes.forEach(node => {
                    fromSelect.innerHTML += `<option value="${node.id}">${node.label}</option>`;
                    toSelect.innerHTML += `<option value="${node.id}">${node.label}</option>`;
                });
            }
        }

        function updateNodeCountDisplay() {
            const maxVMs = parseInt(document.getElementById('num_vms').value);
            const currentNodeCount = customNodes ? customNodes.length : 0;
            const display = document.getElementById('node-count-display');
            const addBtn = document.getElementById('add-node-btn');
            
            if (display) {
                display.textContent = `Nodos: ${currentNodeCount} / ${maxVMs}`;
            }
            
            // Habilitar/deshabilitar botón de agregar nodo
            if (addBtn) {
                if (currentNodeCount >= maxVMs) {
                    addBtn.disabled = true;
                    addBtn.title = `Límite de ${maxVMs} nodos alcanzado`;
                } else {
                    addBtn.disabled = false;
                    addBtn.title = 'Agregar un nuevo nodo';
                }
            }
        }

        function updateTopologyData() {
            if (customNodes && customEdges) {
                const topologyData = {
                    nodes: customNodes.get(),
                    edges: customEdges.get()
                };
                document.getElementById('topology_data').value = JSON.stringify(topologyData);
                updateNodeCountDisplay();
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            generateVMConfig();
            selectTopology('star');
        });
    </script>
</body>
</html>